<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Riches Dashboard â€” Console & Wallet</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#f5f7fb; --card:#fff; --muted:#6b7280; --accent:#1a73e8;
  --accent-2:#0b5bd7; --success:#16a34a; --danger:#ea4335; --radius:12px;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
  --max-width:1200px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#eef2ff 0%,var(--bg) 100%);color:#0f1724;-webkit-font-smoothing:antialiased}
.container{max-width:var(--max-width);margin:0 auto;padding:18px}
.app{display:flex;gap:18px;min-height:80vh;align-items:flex-start}
.sidebar{width:260px;background:linear-gradient(180deg,#fff,#fbfdff);border-radius:var(--radius);padding:18px;border:1px solid #e6eef8;display:flex;flex-direction:column;gap:12px;box-shadow:0 6px 18px rgba(11,20,45,0.04)}
.brand{display:flex;align-items:center;gap:10px;font-weight:700;color:var(--accent)}
.logo{width:38px;height:38px;background:linear-gradient(135deg,var(--accent),var(--accent-2));border-radius:8px;display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-family:var(--mono)}
.subtitle{font-size:13px;color:var(--muted)}
.nav{display:flex;flex-direction:column;gap:6px;margin-top:4px}
.nav button{background:transparent;border:none;text-align:left;padding:10px;border-radius:8px;cursor:pointer;font-weight:700;color:#0f1724}
.nav button.small{font-weight:600;color:var(--muted);font-size:13px}
.nav button.active{background:linear-gradient(90deg, rgba(26,115,232,0.08), rgba(26,115,232,0.02));color:var(--accent)}
.sidebar .small{font-size:12px;color:var(--muted)}
.footer{margin-top:auto;font-size:12px;color:var(--muted)}

/* main */
.main{flex:1;display:flex;flex-direction:column;gap:14px}
.topbar{display:flex;align-items:center;gap:12px}
.property{display:flex;align-items:center;gap:12px;background:var(--card);padding:10px 12px;border-radius:10px;border:1px solid #eef4ff;box-shadow:0 1px 3px rgba(12,18,28,0.03)}
.property .name{font-weight:800}
.controls{margin-left:auto;display:flex;gap:8px;align-items:center}
.btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
.btn.ghost{background:transparent;border:1px solid rgba(13,110,253,0.12);color:var(--accent)}
.btn.small{padding:6px 8px;font-size:14px}

/* cards */
.cards{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.card{background:var(--card);padding:14px;border-radius:10px;border:1px solid #eef4ff;box-shadow:0 1px 6px rgba(12,18,28,0.03)}
.metric{font-size:20px;font-weight:800}
.metric-sub{font-size:13px;color:var(--muted);margin-top:6px}
.delta{font-size:13px;margin-left:8px}

/* content */
.content{display:grid;grid-template-columns:2fr 1fr;gap:12px}
.panel{background:var(--card);padding:14px;border-radius:10px;border:1px solid #eef4ff}
.panel h3{margin:0 0 12px 0;font-size:16px}
.muted{color:var(--muted)}
.small{font-size:13px;color:var(--muted)}
.chart-wrap{height:320px}

/* tables */
table{width:100%;border-collapse:collapse;font-size:14px}
thead th{font-weight:700;text-align:left;color:var(--muted);padding:8px 6px;border-bottom:1px dashed #eef2ff}
tbody td{padding:10px 6px;border-bottom:1px solid #f5f8fb}
.badge{display:inline-block;background:#f3f9f5;color:var(--success);padding:6px 8px;border-radius:999px;font-weight:700;font-size:13px}

/* wallet */
.wallet-header{display:flex;align-items:center;gap:12px;justify-content:space-between}
.balance{font-size:28px;font-weight:800}
.tx-list{max-height:260px;overflow:auto}

/* modals */
.modal-backdrop{position:fixed;inset:0;background:rgba(11,20,45,0.45);display:none;align-items:center;justify-content:center;z-index:60}
.modal{background:var(--card);padding:18px;border-radius:12px;max-width:520px;width:92%;box-shadow:0 10px 40px rgba(11,20,45,0.12)}
.row{display:flex;gap:8px;margin-top:8px}
.close-x{margin-left:auto;border:none;background:transparent;font-size:18px;cursor:pointer}
.input-text{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef8}

/* news */
.news-list{max-height:260px;overflow:auto}
.news-item{padding:8px;border-bottom:1px solid #f4f7fb}
.news-item a{color:var(--accent);text-decoration:none;font-weight:700}

/* responsive */
@media (max-width:1000px){
  .sidebar{display:none}
  .cards{grid-template-columns:repeat(2,1fr)}
  .content{grid-template-columns:1fr;gap:10px}
}

/* dark mode */
body.dark{background:#0b1220;color:#e6eef8}
body.dark .card, body.dark .panel, body.dark .property, body.dark .sidebar, body.dark .modal{background:#0f1724;color:#e6eef8;border-color:#162032}
body.dark .muted{color:#93a4b9}
body.dark .nav button{color:#dbeafe}
body.dark .nav button.active{background:rgba(59,130,246,0.12);color:var(--accent)}
</style>
</head>
<body>
<div class="container">
  <div class="app" role="application" aria-label="Riches Dashboard">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Main navigation">
      <div class="brand" aria-hidden="true">
        <div class="logo">RD</div>
        <div>
          <div>Riches Dashboard</div>
          <div class="subtitle">Performance & Wallet</div>
        </div>
      </div>

      <nav class="nav" role="navigation" aria-label="Primary">
        <button class="active" data-view="home">Home</button>
        <button data-view="dashboard">Performance</button>
        <button data-view="wallet">Wallet</button>
        <button data-view="send">Send</button>
        <button data-view="receive">Receive</button>
        <button data-view="settings" class="small">Settings</button>
      </nav>

      <div class="small">Property</div>
      <div class="property" style="padding:10px">
        <div style="font-weight:700" id="siteName">example.com</div>
        <div class="muted" style="font-size:13px" id="siteStatus">Verified</div>
      </div>

      <div class="footer">Â© Riches Dashboard â€” demo app</div>
    </aside>

    <!-- Main -->
    <main class="main" id="mainArea">
      <div class="topbar" role="region" aria-label="Topbar">
        <div class="property" aria-hidden="true">
          <div style="display:flex;flex-direction:column">
            <div class="name" id="pageTitle">Home</div>
            <div class="muted small">Overview & news</div>
          </div>
        </div>

        <div class="controls" role="toolbar" aria-label="Controls">
          <select id="range" class="input-text" style="width:170px">
            <option value="7">Last 7 days</option>
            <option value="28" selected>Last 28 days</option>
            <option value="90">Last 90 days</option>
            <option value="365">Last 12 months</option>
          </select>
          <button class="btn small" id="themeToggle" title="Toggle theme">ðŸŒ™</button>
          <button class="btn small" id="refreshBtn">Refresh</button>
          <button class="btn ghost small" id="exportBtn">Export CSV</button>
          <button class="btn ghost small" id="verifyBtn">Verify site</button>
        </div>
      </div>

      <!-- HOME -->
      <section id="view-home" class="panel" aria-live="polite">
        <div style="display:flex;gap:12px;align-items:center">
          <div style="flex:1">
            <h3>Overview</h3>
            <p class="muted">Performance snapshot & wallet balance</p>
          </div>
          <div style="display:flex;gap:12px;align-items:center">
            <div style="text-align:right">
              <div class="muted small">Wallet balance</div>
              <div class="balance" id="homeBalance">â‚¦0.00</div>
            </div>
            <div>
              <button class="btn" onclick="openReceive()">Receive</button>
              <button class="btn ghost" onclick="openSend()">Send</button>
            </div>
          </div>
        </div>

        <div class="cards" style="margin-top:12px">
          <div class="card">
            <div class="metric" id="m-clicks">0</div>
            <div class="metric-sub">Clicks <span id="d-clicks" class="delta"></span></div>
          </div>
          <div class="card">
            <div class="metric" id="m-impr">0</div>
            <div class="metric-sub">Impressions <span id="d-impr" class="delta"></span></div>
          </div>
          <div class="card">
            <div class="metric" id="m-ctr">0%</div>
            <div class="metric-sub">Avg CTR <span id="d-ctr" class="delta"></span></div>
          </div>
          <div class="card">
            <div class="metric" id="m-pos">0.0</div>
            <div class="metric-sub">Avg position <span id="d-pos" class="delta"></span></div>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-top:12px">
          <div class="panel">
            <h4>Performance (chart)</h4>
            <div class="chart-wrap">
              <canvas id="homeChart"></canvas>
            </div>
          </div>

          <aside class="panel">
            <h4>Latest news</h4>
            <div id="newsList" class="news-list">
              <!-- clickable Google News link inserted here -->
              <div class="news-item">
                <a href="https://news.google.com/home?hl=en-NG&gl=NG&ceid=NG:en" target="_blank" rel="noopener noreferrer">
                  Open Google News (Nigeria)
                </a>
                <div class="muted small">Click to open the official Google News page in a new tab</div>
              </div>
            </div>
            <div style="margin-top:8px">
              <small class="muted">Tip: You can add a News API key in Settings for additional headlines.</small>
            </div>
          </aside>
        </div>
      </section>

      <!-- DASHBOARD -->
      <section id="view-dashboard" class="panel hidden">
        <h3>Search Console â€” Performance</h3>
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
          <div class="small muted">Metric</div>
          <select id="metricSelect" class="input-text" style="width:150px">
            <option value="clicks">Clicks</option>
            <option value="impressions">Impressions</option>
            <option value="ctr">CTR</option>
            <option value="position">Position</option>
          </select>
          <div style="margin-left:auto" class="small muted" id="sourceNote">Live (simulated)</div>
        </div>

        <div class="chart-wrap">
          <canvas id="dashChart"></canvas>
        </div>

        <div style="margin-top:14px">
          <h4>Top queries</h4>
          <div style="overflow:auto;max-height:180px">
            <table>
              <thead><tr><th>Query</th><th>Clicks</th><th>Impressions</th><th>CTR</th></tr></thead>
              <tbody id="dashQueries"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- WALLET -->
      <section id="view-wallet" class="panel hidden">
        <div class="wallet-header">
          <div>
            <div class="muted small">Available balance</div>
            <div class="balance" id="walletBalance">â‚¦0.00</div>
          </div>
          <div>
            <button class="btn" onclick="openReceive()">Receive</button>
            <button class="btn ghost" onclick="openSend()">Send</button>
          </div>
        </div>

        <div style="margin-top:12px" class="panel">
          <h4>Transaction History</h4>
          <div class="tx-list">
            <table>
              <thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Note</th></tr></thead>
              <tbody id="txTbody"></tbody>
            </table>
          </div>
          <div style="margin-top:8px">
            <button class="btn ghost" id="exportTx">Export transactions</button>
          </div>
        </div>
      </section>

      <!-- SEND -->
      <section id="view-send" class="panel hidden">
        <h3>Send funds</h3>
        <form id="sendForm">
          <label>Recipient address</label>
          <input id="sendTo" class="input-text" placeholder="enter address or email"/><br/>
          <label>Amount</label>
          <input id="sendAmount" type="number" class="input-text" placeholder="0.00"/><br/>
          <label>Note (optional)</label>
          <input id="sendNote" class="input-text" placeholder="Purpose"/><br/>
          <div style="margin-top:8px">
            <button type="submit" class="btn">Send</button>
          </div>
          <div id="sendMsg" style="color:#c00;margin-top:8px"></div>
        </form>
      </section>

      <!-- RECEIVE -->
      <section id="view-receive" class="panel hidden">
        <h3>Receive funds</h3>
        <div>
          <p class="muted">Your receiving address:</p>
          <div style="padding:12px;background:#f8fafc;border-radius:8px;word-break:break-all" id="receiveAddress"></div>
          <div style="margin-top:12px">
            <button class="btn" id="copyAddr">Copy address</button>
          </div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="view-settingsPanel" class="panel hidden">
        <h3>Settings</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <label>Display name</label>
            <input id="profileName" class="input-text" placeholder="Your name"/><br/><br/>
            <label>Email</label>
            <input id="profileEmail" class="input-text" placeholder="you@example.com"/><br/><br/>
            <button class="btn" id="saveProfile">Save profile</button>
          </div>
          <div>
            <label>News API key (optional)</label>
            <input id="newsKey" class="input-text" placeholder="Paste NewsAPI.org key here"/><br/><br/>
            <small class="muted">If you add a NewsAPI key, the News widget will fetch headlines (optional).</small>
            <div style="margin-top:12px">
              <label>Theme</label>
              <select id="themeSelect" class="input-text">
                <option value="auto">Auto (system)</option>
                <option value="light">Light</option>
                <option value="dark">Dark</option>
              </select>
            </div>
          </div>
        </div>

        <div style="margin-top:12px">
          <h4>Site verification</h4>
          <p class="muted">Toggle verification (client-side simulation)</p>
          <button class="btn ghost" id="toggleVerify">Toggle verify</button>
          <div id="verifyMsg" class="muted" style="margin-top:8px"></div>
        </div>
      </section>

    </main>
  </div>
</div>

<!-- Send modal -->
<div class="modal-backdrop" id="sendModal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div style="display:flex;align-items:center;gap:12px">
      <h4 style="margin:0">Send funds</h4>
      <button class="close-x" onclick="closeModal('sendModal')">âœ•</button>
    </div>
    <form id="modalSendForm" style="margin-top:10px">
      <label>Recipient</label>
      <input id="modalTo" class="input-text" placeholder="Address or email"/><br/>
      <label>Amount</label>
      <input id="modalAmount" type="number" class="input-text" placeholder="0.00"/><br/>
      <label>Note</label>
      <input id="modalNote" class="input-text" placeholder="Optional"/><br/>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="btn" type="submit">Confirm send</button>
        <button class="btn ghost" type="button" onclick="closeModal('sendModal')">Cancel</button>
      </div>
      <div id="modalSendMsg" style="color:#c00;margin-top:8px"></div>
    </form>
  </div>
</div>

<!-- Receive modal -->
<div class="modal-backdrop" id="receiveModal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div style="display:flex;align-items:center;gap:12px">
      <h4 style="margin:0">Receive funds</h4>
      <button class="close-x" onclick="closeModal('receiveModal')">âœ•</button>
    </div>
    <div style="margin-top:10px">
      <p class="muted">Share this address to receive funds:</p>
      <div style="padding:12px;background:#f8fafc;border-radius:8px;word-break:break-all" id="modalReceiveAddr"></div>
      <div style="margin-top:10px">
        <button class="btn" id="modalCopyAddr">Copy</button>
        <button class="btn ghost" onclick="closeModal('receiveModal')">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
/* -----------------------
   Single-file Riches Dashboard
   ----------------------- */

function $(id){ return document.getElementById(id); }
function fmtN(n){ return 'â‚¦' + Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

const STORAGE_KEY = 'riches_dashboard_state_v1';
let state = {
  profile: { name: 'Riches User', email: 'user@example.com' },
  wallet: { balance: 5000000.00, address: 'rcv-RICHES-0001' }, // 5,000,000 naira initial
  tx: [],
  verified: true,
  newsKey: null,
  theme: 'auto'
};

function loadState(){
  try{
    const s = localStorage.getItem(STORAGE_KEY);
    if(s) {
      const parsed = JSON.parse(s);
      // keep wallet.balance default if missing to ensure 5M on first-run
      state = Object.assign(state, parsed);
      if(typeof state.wallet?.balance !== 'number') state.wallet.balance = 5000000;
    }
  }catch(e){ console.warn('load state failed', e); }
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

/* Init */
loadState();
syncProfileUI();
syncWalletUI();
applyTheme(state.theme);

/* Navigation wiring */
document.querySelectorAll('.nav button').forEach(btn=>{
  btn.addEventListener('click', (ev)=>{
    const view = btn.getAttribute('data-view');
    activateNavButton(btn);
    showView(view);
  });
});
function activateNavButton(btn){
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

/* Show/Hide views */
function hideAllViews(){
  ['view-home','view-dashboard','view-wallet','view-send','view-receive','view-settingsPanel'].forEach(id=>{
    const el = $(id); if(el) el.classList.add('hidden');
  });
}
function showView(name){
  $('pageTitle').textContent = (name==='home')? 'Home' : name.charAt(0).toUpperCase() + name.slice(1);
  hideAllViews();
  if(name==='home') $('view-home').classList.remove('hidden');
  if(name==='dashboard'){ $('view-dashboard').classList.remove('hidden'); renderDashboard(); }
  if(name==='wallet'){ $('view-wallet').classList.remove('hidden'); renderTxList(); }
  if(name==='send'){ $('view-send').classList.remove('hidden'); }
  if(name==='receive'){ $('view-receive').classList.remove('hidden'); $('receiveAddress').textContent = state.wallet.address; }
  if(name==='settings'){ $('view-settingsPanel').classList.remove('hidden'); populateSettings(); }
  document.title = 'Riches Dashboard â€¢ ' + $('pageTitle').textContent;
}

/* Start at Home */
showView('home');

/* Controls */
$('themeToggle').addEventListener('click', ()=>{
  const newTheme = document.body.classList.contains('dark') ? 'light' : 'dark';
  setTheme(newTheme);
});
$('refreshBtn').addEventListener('click', ()=> { refreshAll(); });
$('verifyBtn').addEventListener('click', ()=> { toggleVerify(); });
$('exportBtn').addEventListener('click', exportSnapshot);

/* Send / Receive modal handling */
function openSend(){
  showView('send');
  $('modalTo').value=''; $('modalAmount').value=''; $('modalNote').value='';
  $('sendModal').style.display='flex'; $('sendModal').setAttribute('aria-hidden','false');
}
function openReceive(){
  $('modalReceiveAddr').textContent = state.wallet.address;
  $('receiveModal').style.display='flex'; $('receiveModal').setAttribute('aria-hidden','false');
}
function closeModal(id){ $(id).style.display='none'; $(id).setAttribute('aria-hidden','true'); }

/* Modal submit: send */
$('modalSendForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const to = $('modalTo').value.trim();
  const amount = parseFloat($('modalAmount').value);
  const note = $('modalNote').value.trim();
  if(!to || isNaN(amount) || amount <= 0){ $('modalSendMsg').textContent='Enter valid recipient and amount'; return; }
  if(amount > state.wallet.balance){ $('modalSendMsg').textContent='Insufficient funds'; return; }
  state.wallet.balance -= amount;
  const tx = { id: 'tx'+Date.now(), date: new Date().toISOString(), type:'Sent', amount, note, to };
  state.tx.unshift(tx);
  saveState(); syncWalletUI(); renderTxList();
  $('modalSendMsg').textContent='Sent âœ“';
  setTimeout(()=> closeModal('sendModal'), 900);
});

/* Copy address */
$('modalCopyAddr').addEventListener('click', ()=> navigator.clipboard?.writeText(state.wallet.address).then(()=> alert('Address copied')));
$('copyAddr').addEventListener('click', ()=> navigator.clipboard?.writeText(state.wallet.address).then(()=> alert('Copied')));

/* Inline send form */
$('sendForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const to = $('sendTo').value.trim();
  const amount = parseFloat($('sendAmount').value);
  const note = $('sendNote').value.trim();
  if(!to || isNaN(amount) || amount <= 0){ $('sendMsg').textContent='Enter valid recipient and amount'; return; }
  if(amount > state.wallet.balance){ $('sendMsg').textContent='Insufficient funds'; return; }
  state.wallet.balance -= amount;
  const tx = { id:'tx'+Date.now(), date: new Date().toISOString(), type:'Sent', amount, note, to };
  state.tx.unshift(tx);
  saveState(); syncWalletUI(); renderTxList(); $('sendMsg').textContent='Sent âœ“';
  setTimeout(()=> { $('sendMsg').textContent=''; showView('wallet'); }, 700);
});

/* Simulate receive (for testing) */
function simulateReceive(amount=randInt(1000,50000), note='Deposit'){
  state.wallet.balance += amount;
  const tx = { id:'tx'+Date.now(), date:new Date().toISOString(), type:'Received', amount, note, from:'external' };
  state.tx.unshift(tx);
  saveState(); syncWalletUI(); renderTxList();
  alert('Received ' + fmtN(amount));
}

/* Wallet UI sync */
function syncWalletUI(){
  $('homeBalance').textContent = fmtN(state.wallet.balance);
  $('walletBalance').textContent = fmtN(state.wallet.balance);
  $('receiveAddress').textContent = state.wallet.address;
  saveState();
}

/* Transactions render */
function renderTxList(){
  const tbody = $('txTbody');
  tbody.innerHTML = '';
  if(!state.tx || state.tx.length===0){
    tbody.innerHTML = '<tr><td colspan="4" class="muted">No transactions yet</td></tr>'; return;
  }
  state.tx.forEach(t=>{
    const d = new Date(t.date).toLocaleString();
    tbody.insertAdjacentHTML('beforeend', `<tr><td>${d}</td><td>${t.type}</td><td>${fmtN(t.amount)}</td><td>${t.note || t.to || t.from || ''}</td></tr>`);
  });
}
$('exportTx')?.addEventListener('click', ()=>{
  const rows=[['Date','Type','Amount','Note']];
  state.tx.forEach(t=> rows.push([new Date(t.date).toISOString(), t.type, t.amount, t.note||'']));
  const csv = rows.map(r=> r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='transactions.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

/* Performance generation + charts */
let homeChart=null, dashChart=null;
function generatePerformance(days=28){
  const labels=[], clicks=[], impressions=[], ctr=[], pos=[];
  for(let i=days-1;i>=0;i--){
    const d=new Date(); d.setDate(d.getDate()-i);
    labels.push(d.toISOString().slice(0,10));
    const impr = randInt(400,3500);
    const clk = Math.max(0, Math.floor(impr*(0.01 + Math.random()*0.07)));
    clicks.push(clk); impressions.push(impr);
    ctr.push(Number(((clk/impr)*100).toFixed(2)));
    pos.push(Number((1 + Math.random()*30).toFixed(2)));
  }
  return {labels, clicks, impressions, ctr, pos};
}
function renderHomeChart(){
  const data = generatePerformance(parseInt($('range').value,10));
  $('m-clicks').textContent = data.clicks.reduce((a,b)=>a+b,0).toLocaleString();
  $('m-impr').textContent = data.impressions.reduce((a,b)=>a+b,0).toLocaleString();
  $('m-ctr').textContent = (data.ctr.reduce((a,b)=>a+b,0)/data.ctr.length).toFixed(1) + '%';
  $('m-pos').textContent = (data.pos.reduce((a,b)=>a+b,0)/data.pos.length).toFixed(2);

  const ctx = $('homeChart').getContext('2d');
  if(homeChart) homeChart.destroy();
  homeChart = new Chart(ctx, {
    type:'line',
    data:{ labels:data.labels, datasets:[{ label:'Clicks', data:data.clicks, borderColor:'#1a73e8', backgroundColor:'rgba(26,115,232,0.06)', fill:true, tension:0.25 }]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}
  });
}
function renderDashboard(){
  const metric = $('metricSelect').value;
  const days = parseInt($('range').value,10);
  const data = generatePerformance(days);
  const dataset = (metric==='clicks') ? data.clicks : (metric==='impressions' ? data.impressions : (metric==='ctr' ? data.ctr : data.pos));
  const ctx = $('dashChart').getContext('2d');
  if(dashChart) dashChart.destroy();
  dashChart = new Chart(ctx, {
    type:'line',
    data:{ labels:data.labels, datasets:[{ label:metric, data:dataset, borderColor:'#0b74ff', backgroundColor:'rgba(11,116,255,0.06)', fill:true, tension:0.2 }]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}
  });

  const qbody = $('dashQueries'); qbody.innerHTML='';
  const sampleQs = ['example query','how to setup','best tools','learn seo','dashboard tutorial','site verification','performance tips','analytics guide'];
  sampleQs.forEach(q=>{
    const clicks = randInt(10,900); const impr = clicks * randInt(10,80);
    qbody.insertAdjacentHTML('beforeend', `<tr><td>${q}</td><td>${clicks.toLocaleString()}</td><td>${impr.toLocaleString()}</td><td>${((clicks/impr)*100).toFixed(1)}%</td></tr>`);
  });
}

/* News widget: clickable Google News link already present; optionally show simulated headlines below the link */
function fetchNews(){
  const newsList = $('newsList');
  // ensure Google News link remains at top (already added in HTML). Append simulated headlines afterward
  const sims = [
    {t:'Search Console tips for 2025', s:'Console News'},
    {t:'New SEO patterns emerging', s:'SEO Daily'},
    {t:'How to verify your site quickly', s:'Webmaster Blog'}
  ];
  sims.forEach(s=>{
    const el = document.createElement('div'); el.className='news-item';
    el.innerHTML = `<div style="font-weight:700">${s.t}</div><div class="muted small">${s.s}</div>`;
    newsList.appendChild(el);
  });
}

/* Refresh routine */
function refreshAll(){
  renderHomeChart();
  if(!homeChart) renderHomeChart();
  if(!$('view-dashboard').classList.contains('hidden')) renderDashboard();
  fetchNews();
  syncWalletUI();
}

/* Settings */
$('saveProfile')?.addEventListener('click', ()=>{
  state.profile.name = $('profileName').value || state.profile.name;
  state.profile.email = $('profileEmail').value || state.profile.email;
  state.newsKey = $('newsKey').value || null;
  if(state.newsKey) localStorage.setItem('news_api_key', state.newsKey);
  state.theme = $('themeSelect').value||state.theme;
  saveState(); syncProfileUI(); alert('Settings saved');
});
$('toggleVerify')?.addEventListener('click', ()=> toggleVerify());
function populateSettings(){
  $('profileName').value = state.profile.name || '';
  $('profileEmail').value = state.profile.email || '';
  $('newsKey').value = state.newsKey || localStorage.getItem('news_api_key') || '';
  $('themeSelect').value = state.theme || 'auto';
  $('verifyMsg').textContent = state.verified ? 'Site is marked verified (client-side).' : 'Site is not verified';
}

/* Verify toggle */
function toggleVerify(){
  state.verified = !state.verified;
  $('siteStatus').textContent = state.verified ? 'Verified' : 'Not verified';
  $('verifyMsg') && ($('verifyMsg').textContent = state.verified ? 'Site verified (client-side simulated).' : 'Site not verified');
  saveState();
}

/* Profile UI */
function syncProfileUI(){
  $('siteName').textContent = state.profile.name ? state.profile.name.toLowerCase().replace(/\s+/g,'') + '.example' : 'example.com';
  $('profileName') && ($('profileName').value = state.profile.name);
  $('profileEmail') && ($('profileEmail').value = state.profile.email);
  $('homeBalance').textContent = fmtN(state.wallet.balance);
}

/* Settings population on start */
function populateSettingsOnStart(){
  $('profileName') && ($('profileName').value = state.profile.name);
  $('profileEmail') && ($('profileEmail').value = state.profile.email);
  $('newsKey') && ($('newsKey').value = state.newsKey || localStorage.getItem('news_api_key') || '');
  $('themeSelect') && ($('themeSelect').value = state.theme || 'auto');
}
populateSettingsOnStart();

/* Theme handling */
function setTheme(t){
  if(t==='dark'){ document.body.classList.add('dark'); state.theme='dark'; }
  else if(t==='light'){ document.body.classList.remove('dark'); state.theme='light'; }
  else { // auto
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme:dark)').matches;
    document.body.classList.toggle('dark', prefersDark);
    state.theme='auto';
  }
  saveState();
}
function applyTheme(t){
  if(t==='dark') document.body.classList.add('dark');
  else if(t==='light') document.body.classList.remove('dark');
  else { const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme:dark)').matches; document.body.classList.toggle('dark', prefersDark); }
}
applyTheme(state.theme);

/* Keyboard shortcuts */
window.addEventListener('keydown',(e)=>{
  if(e.key === '1') document.querySelector('.nav button[data-view="home"]').click();
  if(e.key === '2') document.querySelector('.nav button[data-view="dashboard"]').click();
  if(e.key === '3') document.querySelector('.nav button[data-view="wallet"]').click();
});

/* Initial actions */
refreshAll();
renderTxList();
syncWalletUI();

/* Save before unload */
window.addEventListener('beforeunload', ()=> saveState());

/* Expose some helpers for debugging */
window.__RICHES = { state, refreshAll, simulateReceive, saveState };

</script>
</body>
</html>
